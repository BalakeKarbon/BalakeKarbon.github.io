<html lang="eng">
<head>
	<meta charset="utf-8"/>
	<title>web-portfolio</title>
</head>
<body>
	<div id='terminal-container'></div>
	<noscript>You are extra cool because whatever you are viewing this on does not support javascript!</noscript>
	<script src="/base.js"></script>
	<script>
		function adjustScale() {
			if(window.innerHeight < (window.innerWidth*0.75)) {
				document.getElementById('terminal-container').style.width=window.innerHeight*1.3333333333333333;
				document.getElementById('terminal-container').style.height=window.innerHeight;
				document.getElementById('terminal-container').style.marginLeft=((window.innerWidth-(window.innerHeight*1.3333333333333333))/2)+'px';
			} else {
				document.getElementById('terminal-container').style.width=window.innerWidth;
				document.getElementById('terminal-container').style.height=window.innerWidth*0.75;
				document.getElementById('terminal-container').style.marginLeft='0%';
			};
		}
		//I WISH I WAS WRITING IN JAVA!
		var fontSize=20;
		var terminalScreenBorder=10;
		var rows=(400-(terminalScreenBorder*2))/fontSize;
		var cols=(500-(terminalScreenBorder*2))/(fontSize/2);
		var scroll=0;
		var terminalLinks=[null]; //Setup links first then revert back to them!
		var terminalBuffer=[]; //Array of strings with the length of cols along with integer array referencing links.
		var typeRate=1;
		var terminalCanvas=document.createElement("canvas");
		var terminalContext=terminalCanvas.getContext("2d");
		terminalCanvas.width=500;
		terminalCanvas.height=400;
		terminalCanvas.style.position='absolute';
		terminalCanvas.style.top='4.1666666666666664%';
		terminalCanvas.style.left='9.375%';
		terminalCanvas.style.width='62.5%';
		terminalCanvas.style.height='66.66666666666667%';
		var depletionInterval=20;
		var depletionSize=10;
		var rrgb=[0,30,0];
		function deplete() {
			var screenImageData = terminalContext.getImageData(0,0,terminalCanvas.width,terminalCanvas.height);
		  for(var cp=0;cp<screenImageData.data.length;cp+=4) {
		    for(var cc=0;cc<3;cc++) {
		      if(screenImageData.data[cp+cc]!=rrgb[cc]) {
		      	var diff=screenImageData.data[cp+cc]-rrgb[cc];
		        if(diff>0) {
		          if(depletionSize<Math.abs(diff)) {
		          	screenImageData.data[cp+cc]-=depletionSize;
		          } else {
		          	screenImageData.data[cp+cc]-=diff;
		          }
		        } else if(diff<0) {
		        	if(depletionSize<Math.abs(diff)) {
		          	screenImageData.data[cp+cc]+=depletionSize;
		          } else {
		          	screenImageData.data[cp+cc]+=diff;
		          }
		        }
		      }
		    }
		  }
		  terminalContext.putImageData(screenImageData,0,0);
		}
		terminalContext.fillStyle = "#00FF00";
		terminalContext.fillRect(0, 0, terminalCanvas.width, terminalCanvas.height);
		setInterval(deplete,depletionInterval);
		var terminalCursor = {
			x:0,
			y:0
		};
		var terminalLines=[];
		function initTerminalLines() {
			terminalLines=[];
			var tli=0;
			if(terminalLines.length!=0) {
				for(tli=(terminalLines.length-1);tli>=0;tli--) {
					terminalLines[tli].remove()
					terminalLines.pop();
				}
			}
			for(tli=0;tli<rows;tli++) {
				var newLine = document.createElementNS('http://www.w3.org/2000/svg','text');
				newLine.setAttribute('x',75+terminalScreenBorder);
				newLine.setAttribute('y',25+((terminalScreenBorder+((tli)*fontSize))+fontSize));
				newLine.setAttribute('style','font-size:'+fontSize+'px;font-family:localUnifont;fill:#00FF00;fill-opacity:1;stroke:none;stroke-width:0.0');
				newLine.textContent='';
				document.getElementById('terminal').insertBefore(newLine,document.getElementById('terminal').firstChild);
				terminalLines.push(newLine);
			}
		}
		function adjustFont(newSize) {
			fontSize=newSize;
			rows=(400-(terminalScreenBorder*2))/fontSize;
			cols=(500-(terminalScreenBorder*2))/(fontSize/2);
			terminalBuffer=[]; //Reset Buffer!
			terminalCursor.x=0;
			terminalCursor.y=0;
		}
		var lineIndex=0;
		var lineStop=0;
		function render() {
			deplete();
			if(terminalBuffer.length<=rows) {
				scroll=0;
			}
			lineIndex=(terminalBuffer.length-1)-scroll;
			lineStop=lineIndex-(rows-1);
			if(lineStop<0) {
				lineStop=0;
			}
			while(lineIndex>=lineStop) {
				terminalLines[lineIndex-lineStop].innerHTML='';
				terminalLines[lineIndex-lineStop][1]=[];
				var curText=terminalBuffer[lineIndex];
				for(var curChar=0;curChar<cols;curChar++) {
					if(curText[0].length>curChar) {
						terminalContext.fillText(curText[0][curChar],terminalScreenBorder+((fontSize/2)*curChar),(terminalScreenBorder+((lineIndex-lineStop)*fontSize))+fontSize);
						var newLink = document.createElementNS('http://www.w3.org/2000/svg','tspan');
						if(curText[1][curChar]!=0) {
							newLink.onclick=terminalLinks[curText[1][curChar]];
						}
						if(curText[0].charAt(curChar)==' ') {
							newLink.innerHTML+='&nbsp;';
						} else {
							newLink.innerHTML+=curText[0].charAt(curChar);
						}
						terminalLines[lineIndex-lineStop].appendChild(newLink);
					}
				}
				lineIndex--;
			}
		}
		function getCurrentLine() {
			if(terminalCursor.y>rows) {
				terminalCursor.y=rows;
			} else if(terminalCursor.y<0) {
				terminalCursor.y=0;
			}
			if(terminalCursor.x>cols) {
				terminalCursor.x=cols;
			} else if(terminalCursor.x<0) {
				terminalCursor.x=0;
			}
			while(terminalBuffer[terminalCursor.y]==null) {
				terminalBuffer.push(['',[]]);
			}
			for(var cbli=0;cbli<cols;cbli++) {
				terminalBuffer[terminalBuffer.length-1][1].push(0);
			}
			var offsetRow=0;
			if(terminalBuffer.length<=rows) {
				offsetRow=terminalCursor.y;
			} else {
				offsetRow=((terminalBuffer.length-1)-rows)+terminalCursor.y;
			}
			var curLine=terminalBuffer[offsetRow];
			while(curLine[0].length<terminalCursor.x) {
				curLine[0]+=' ';
				curLine[1].push(0);
			}
			return [curLine,offsetRow];
		}
		var writingChar=false;
		function setChar(char,link) {
			if(writingChar==false) {
				writingChar=true;
				var curLine=getCurrentLine();
				curLine[0][0]=curLine[0][0].substr(0, terminalCursor.x) + char+ curLine[0][0].substr(terminalCursor.x + 1);
				curLine[0][1][terminalCursor.x]=link;
				writingChar=false;
			}
		}
		var writingString=false;
		var wcnli=0;
		var wccci=0;
		var wcnl=[];
		var wcfll=0;
		var wclink=0;
		function writeCallback() {
			if(wcnli<wcnl.length) {
				if(wccci<wcnl[wcnli].length) {
					terminalCursor.x=wccci;
					if(wcnli==0) {
						terminalCursor.x+=wcfll;
					}
					setChar(wcnl[wcnli].charAt(wccci),wclink);
					wccci++;
				} else {
					wccci=0;
					wcnli++;
					if(terminalBuffer.length<rows) {
						if(wcnl.length>wcnli) {
							terminalCursor.y++;
							terminalCursor.x=0;
						}
					} else if(wcnli<(wcnl.length)) {
						terminalCursor.y=rows;
						terminalBuffer.push(['',[]]);
						terminalCursor.x=0;
					}
					writeCallback();
				}
				if(wcnli==wcnl.length) {
					writingString=false;
					if(wcnl[wcnl.length-1].charAt(terminalCursor.x)!='') {
						terminalCursor.x++;
					}
					if(terminalCursor.x>cols) {
						terminalCursor.y=rows;
						terminalBuffer.push(['',[]]);
						terminalCursor.x=0;
					}
				}
			}
		}
		function write(tString,link,quick) {
			if(writingString==false) {
				writingString=true;
				var newLines=[''];
				var fll=terminalCursor.x;
				var cls='';
				var nli=0;
				var cc=fll;
				var cci=0;
				for(cci=0;cci<tString.length;cci++) {
					if(tString.charAt(cci)=='\n') {
						newLines.push('');
						nli++;
						cc=0;
					} else {
						newLines[nli]+=tString.charAt(cci);
						if(cc>=(cols-1)) {
							newLines.push('')
							nli++;
							cc=0;
						} else {
							cc++;
						}
					}
				}
				wcnli=0;
				wccci=0;
				wcnl=newLines;
				wcfll=fll;
				wclink=link;
				var cc=0;
				for(nli=0;nli<newLines.length;nli++) {
					for(cci=0;cci<=newLines[nli].length;cci++) {
						if(quick) {
							writeCallback();
							cc++
						} else {
							setTimeout(function() {
								writeCallback();
								render();
							},cc*typeRate);
							cc++;
						}
					}
				}
				if(quick) {
					render();
				}
			}
		}
		function main(fileData) {
			document.getElementById('terminal-container').innerHTML=fileData.responseText;
			document.getElementById('terminal').setAttribute('width','100%');
			document.getElementById('terminal').setAttribute('height','100%');
			document.getElementById('terminal').style.zIndex='-1';
			adjustScale();
			document.getElementById('terminal-container').insertBefore(terminalCanvas,document.getElementById('terminal-container').firstChild);
			terminalCanvas.style.zIndex='-2';
			terminalContext.font=fontSize+'px localUnifont';
			terminalContext.fillStyle = '#00ff00';
			initTerminalLines();
			//setChar('H',0);
			terminalLinks.push(function() {
				loadFile("res/text/lang/eng/test.txt",null,function(fileData) {
					write(fileData.responseText,0,false);
				});
			});
			write('Loading...\n',1,true);
			console.log(terminalCursor);
			//Get cookie data here and load values!

		};
		loadFile("res/img/terminal.svg",null,main);
		window.addEventListener('resize',adjustScale);
	</script>
	<style>
		@font-face {
			font-family: localUnifont;
			src: url(/res/text/fonts/unifont-13.0.01.ttf);
		}
		body {
			margin: 0px 0px 0px 0px;
		}
		#terminal-container {
			position: absolute;
		}
	</style>
</body>
</html>
